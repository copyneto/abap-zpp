sap.ui.define([],                                                                                                                                                                                                                                              
    function () {                                                                                                                                                                                                                                              
        "use strict";                                                                                                                                                                                                                                          
        return {                                                                                                                                                                                                                                               
            onActionDownload: function (oEvent) {                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                var Object = oEvent.getSource().getBindingContext().getObject();                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Prepara serviço                                                                                                                                                                                                                                
                =================================================================== */                                                                                                                                                                         
                var vServiceUrl = "/sap/opu/odata/sap/ZPP_PLANO_PRODUCAO_SRV_EX/";                                                                                                                                                                             
                var oModel = new sap.ui.model.odata.ODataModel(vServiceUrl, false);                                                                                                                                                                            
                var vEntitySet = "downloadSet(Id='" + Object.Id + "')/$value";                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Entra no Gateway&nbsp;                                                                                                                                                                                                                         
                =================================================================== */                                                                                                                                                                         
                var fnFunction = function () {                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                    return new Promise(function (showSuccessMessage, showErrorMessage) {                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        oModel.read(vEntitySet, {                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            success: function (oData, oResponse) {                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                                showSuccessMessage();                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                                sap.m.URLHelper.redirect(oResponse.requestUri, true);                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                            }.bind(this),                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                            error: function (oError) {                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                showErrorMessage();                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                                // Recupera texto da mensagem                                                                                                                                                                                                  
                                let aMessage = [];                                                                                                                                                                                                             
                                for (const res of oError.response.body.matchAll(/(?:<message>(.*?)<[/]message>)/gm)) {                                                                                                                                         
                                    aMessage.push(res[1]);                                                                                                                                                                                                     
                                }                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                                // Recupera o tipo da mensagem                                                                                                                                                                                                 
                                let aSeverity = [];                                                                                                                                                                                                            
                                for (const res of oError.response.body.matchAll(/(?:<severity>(.*?)<[/]severity>)/gm)) {                                                                                                                                       
                                    switch (res[1]) {                                                                                                                                                                                                          
                                        case "error":                                                                                                                                                                                                          
                                            aSeverity.push(sap.ui.core.MessageType.Error);                                                                                                                                                                     
                                            break;                                                                                                                                                                                                             
                                        case "info":                                                                                                                                                                                                           
                                            aSeverity.push(sap.ui.core.MessageType.Information);                                                                                                                                                               
                                            break;                                                                                                                                                                                                             
                                        case "success":                                                                                                                                                                                                        
                                            aSeverity.push(sap.ui.core.MessageType.Success);                                                                                                                                                                   
                                            break;                                                                                                                                                                                                             
                                        case "warning":                                                                                                                                                                                                        
                                            aSeverity.push(sap.ui.core.MessageType.Warning);                                                                                                                                                                   
                                            break;                                                                                                                                                                                                             
                                        default:                                                                                                                                                                                                               
                                            aSeverity.push(sap.ui.core.MessageType.None);                                                                                                                                                                      
                                            break;                                                                                                                                                                                                             
                                    }                                                                                                                                                                                                                          
                                }                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                                // Exibe mensagem                                                                                                                                                                                                              
                                for (let i = 0; i < aMessage.length; i++) {                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                                    if (aMessage[i] == "Ocorreu uma exceção") {                                                                                                                                                                                
                                        continue;                                                                                                                                                                                                              
                                    }                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                                    sap.ui.getCore().getMessageManager().addMessages(new sap.ui.core.message.Message({                                                                                                                                         
                                        message: aMessage[i],                                                                                                                                                                                                  
                                        persistent: true, // create message as transition message                                                                                                                                                              
                                        type: aSeverity[i]                                                                                                                                                                                                     
                                    }));                                                                                                                                                                                                                       
                                }                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            }.bind(this),                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        });                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                    }.bind(this))                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                }.bind(this)                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Configura pop-up de mensagens                                                                                                                                                                                                                  
                =================================================================== */                                                                                                                                                                         
                this.extensionAPI.securedExecution(fnFunction,                                                                                                                                                                                                 
                    {                                                                                                                                                                                                                                          
                        busy: {                                                                                                                                                                                                                                
                            set: true,                                                                                                                                                                                                                         
                            check: false                                                                                                                                                                                                                       
                        },                                                                                                                                                                                                                                     
                        sActionLabel: "Mensagens"                                                                                                                                                                                                              
                    });                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            showSuccessMessage: function (sMessage) {                                                                                                                                                                                                          
                this.getView().setBusy(false);                                                                                                                                                                                                                 
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            showErrorMessage: function (sMessage) {                                                                                                                                                                                                            
                this.getView().setBusy(false);                                                                                                                                                                                                                 
            }                                                                                                                                                                                                                                                  
        };                                                                                                                                                                                                                                                     
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               